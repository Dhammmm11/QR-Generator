<!DOCTYPE html>
<html lang="id" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qr Generator V3 Alpha</title>
    
    <!-- Tailwind CSS (Configured for Class Strategy) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b', // Custom dark shade
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; transition: background-color 0.3s ease, color 0.3s ease; }
        
        /* Smooth Transition for all elements */
        *, *::before, *::after {
            transition-property: background-color, border-color, color, fill, stroke;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 200ms;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 min-h-screen p-4 md:p-8 flex flex-col md:flex-row gap-6 justify-center items-start">

    <!-- BAGIAN KIRI: Form Input -->
    <div class="w-full max-w-md bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden border border-slate-200 dark:border-slate-700">
        
        <!-- Header -->
        <div class="bg-indigo-600 dark:bg-indigo-700 p-6 text-white flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold"><i class="fa-solid fa-qrcode mr-2"></i>QR Generator</h1>
                <p class="text-indigo-200 text-xs">Versi 3.0 Alpha</p>
            </div>
            <div class="flex gap-3">
                <!-- Theme Toggle Button -->
                <button onclick="toggleTheme()" class="w-8 h-8 rounded-full bg-indigo-500 hover:bg-indigo-400 flex items-center justify-center transition shadow-inner" title="Ganti Tema">
                    <i id="themeIcon" class="fa-solid fa-moon text-sm"></i>
                </button>
                <!-- Reset Button -->
                <button onclick="resetApp()" class="text-indigo-200 hover:text-white transition text-sm flex items-center">
                    <i class="fa-solid fa-rotate-right mr-1"></i>
                </button>
            </div>
        </div>

        <div class="p-6 space-y-5">
            
            <!-- Input Nominal & Kalkulator -->
            <div>
                <label class="block text-slate-700 dark:text-slate-300 text-sm font-bold mb-2">Masukan Nominal</label>
                <div class="relative group">
                    <span class="absolute left-3 top-3.5 text-slate-400 font-bold group-focus-within:text-indigo-600 dark:group-focus-within:text-indigo-400 transition">Rp</span>
                    <input type="text" id="nominal" placeholder="0" 
                        class="w-full pl-10 pr-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-xl text-lg font-bold text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white dark:focus:bg-slate-600 transition"
                        onkeypress="handleEnter(event)">
                </div>
                <!-- Presets -->
                <div class="grid grid-cols-4 gap-2 mt-2">
                    <button onclick="addAmount(10000)" class="preset-btn bg-indigo-50 dark:bg-slate-700 text-indigo-700 dark:text-indigo-300 py-1 rounded text-xs font-semibold hover:bg-indigo-100 dark:hover:bg-slate-600 border border-transparent dark:border-slate-600">+10k</button>
                    <button onclick="addAmount(20000)" class="preset-btn bg-indigo-50 dark:bg-slate-700 text-indigo-700 dark:text-indigo-300 py-1 rounded text-xs font-semibold hover:bg-indigo-100 dark:hover:bg-slate-600 border border-transparent dark:border-slate-600">+20k</button>
                    <button onclick="addAmount(50000)" class="preset-btn bg-indigo-50 dark:bg-slate-700 text-indigo-700 dark:text-indigo-300 py-1 rounded text-xs font-semibold hover:bg-indigo-100 dark:hover:bg-slate-600 border border-transparent dark:border-slate-600">+50k</button>
                    <button onclick="addAmount(100000)" class="preset-btn bg-indigo-50 dark:bg-slate-700 text-indigo-700 dark:text-indigo-300 py-1 rounded text-xs font-semibold hover:bg-indigo-100 dark:hover:bg-slate-600 border border-transparent dark:border-slate-600">+100k</button>
                </div>
            </div>

            <!-- Catatan -->
            <div>
                <label class="block text-slate-700 dark:text-slate-300 text-sm font-bold mb-2">Catatan</label>
                <input type="text" id="note" placeholder="Contoh: Tagihan Listrik" 
                    class="w-full px-4 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-sm text-slate-800 dark:text-white focus:outline-none focus:border-indigo-500 transition">
            </div>

            <!-- Kustomisasi Tampilan (Dropdown) -->
            <div class="border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden">
                <button onclick="toggleCustomize()" class="w-full flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 text-sm font-semibold text-slate-600 dark:text-slate-300 transition">
                    <span><i class="fa-solid fa-paintbrush mr-2"></i>Kustomisasi Tampilan</span>
                    <i id="chevron" class="fa-solid fa-chevron-down transition-transform"></i>
                </button>
                <div id="customizePanel" class="hidden p-4 bg-white dark:bg-slate-800 border-t border-slate-100 dark:border-slate-700 space-y-4">
                    
                    <!-- Warna -->
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-600 dark:text-slate-400">Warna QR</span>
                        <div class="flex gap-2">
                            <input type="color" id="colorDark" value="#000000" class="w-8 h-8 rounded cursor-pointer border-0 bg-transparent">
                            <input type="color" id="colorLight" value="#ffffff" class="w-8 h-8 rounded cursor-pointer border-0 bg-transparent">
                        </div>
                    </div>

                    <!-- Logo Upload -->
                    <div>
                        <span class="text-sm text-slate-600 dark:text-slate-400 block mb-2">Upload Logo (Tengah)</span>
                        <input type="file" id="logoInput" accept="image/*" class="block w-full text-xs text-slate-500 dark:text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 dark:file:bg-slate-700 dark:file:text-indigo-300 hover:file:bg-indigo-100 dark:hover:file:bg-slate-600">
                    </div>
                </div>
            </div>

            <button onclick="generateQR()" class="w-full bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-600 dark:hover:bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 dark:shadow-none transition-all transform hover:-translate-y-0.5">
                Generate QR Now! 
            </button>
        </div>
    </div>

    <!-- BAGIAN KANAN: Hasil & History -->
    <div class="w-full max-w-md space-y-6">
        
        <!-- Area Hasil -->
        <div id="resultCard" class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 hidden relative animate-fade-in border border-slate-100 dark:border-slate-700">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-indigo-600"></div>
            
            <h3 class="text-center font-bold text-slate-800 dark:text-white mb-4">Preview Hasil</h3>
            
            <!-- Canvas Wrapper untuk QR -->
            <div class="flex justify-center mb-4">
                <!-- Wrapper ini selalu putih agar QR contrast tetap tinggi -->
                <div id="qr-container" class="p-4 bg-white rounded-xl shadow-inner border border-slate-200 inline-block">
                    <div id="qrcode" class="relative"></div>
                </div>
            </div>

            <div class="text-center mb-6">
                <h2 id="resNominal" class="text-2xl font-bold text-slate-800 dark:text-white">Rp 0</h2>
                <p id="resNote" class="text-sm text-slate-500 dark:text-slate-400">-</p>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="downloadQR()" class="flex items-center justify-center gap-2 bg-slate-800 dark:bg-slate-700 hover:bg-slate-900 dark:hover:bg-slate-600 text-white py-2 px-4 rounded-lg font-medium text-sm transition border border-transparent dark:border-slate-600">
                    <i class="fa-solid fa-download"></i> Simpan
                </button>
                <button onclick="shareQR()" class="flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-medium text-sm transition">
                    <i class="fa-brands fa-whatsapp"></i> Share
                </button>
            </div>
        </div>

        <!-- Area Riwayat -->
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
            <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                <h3 class="font-bold text-slate-700 dark:text-slate-300 text-sm"><i class="fa-solid fa-clock-rotate-left mr-2"></i>Riwayat Terakhir</h3>
                <button onclick="clearHistory()" class="text-xs text-red-500 hover:text-red-700 dark:hover:text-red-400">Hapus Semua</button>
            </div>
            <ul id="historyList" class="divide-y divide-slate-100 dark:divide-slate-700 max-h-60 overflow-y-auto">
                <li class="p-4 text-center text-xs text-slate-400">Belum ada riwayat</li>
            </ul>
        </div>
    </div>

    <script>
        // --- THEME LOGIC ---
        const html = document.documentElement;
        const themeIcon = document.getElementById('themeIcon');

        // Cek preferensi awal
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            html.classList.add('dark');
            updateThemeIcon(true);
        } else {
            html.classList.remove('dark');
            updateThemeIcon(false);
        }

        function toggleTheme() {
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.theme = 'light';
                updateThemeIcon(false);
            } else {
                html.classList.add('dark');
                localStorage.theme = 'dark';
                updateThemeIcon(true);
            }
        }

        function updateThemeIcon(isDark) {
            if (isDark) {
                themeIcon.className = 'fa-solid fa-sun text-yellow-300';
            } else {
                themeIcon.className = 'fa-solid fa-moon text-white';
            }
        }

        // --- LOGIC UTAMA (Sama seperti V2) ---
        let currentNominal = 0;
        let logoImage = null;

        document.addEventListener('DOMContentLoaded', loadHistory);

        const nominalInput = document.getElementById('nominal');
        
        nominalInput.addEventListener('change', function() {
            try {
                let sanitized = this.value.replace(/[^0-9+\-*/]/g, '');
                if(sanitized.indexOf('.') !== -1 && sanitized.length > 3) sanitized = sanitized.replace(/\./g, '');
                let result = eval(sanitized);
                if (!isNaN(result)) {
                    currentNominal = result;
                    updateInputDisplay();
                }
            } catch (e) {}
        });

        nominalInput.addEventListener('input', function(e) {
            if (/^[0-9]+$/.test(this.value.replace(/\./g, ''))) {
                currentNominal = parseInt(this.value.replace(/\./g, '')) || 0;
                this.value = currentNominal.toLocaleString('id-ID');
            }
        });

        function handleEnter(e) {
            if(e.key === 'Enter') generateQR();
        }

        function addAmount(amount) {
            currentNominal += amount;
            updateInputDisplay();
        }

        function updateInputDisplay() {
            nominalInput.value = currentNominal.toLocaleString('id-ID');
        }

        function toggleCustomize() {
            const panel = document.getElementById('customizePanel');
            const chevron = document.getElementById('chevron');
            panel.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180', !panel.classList.contains('hidden'));
        }

        document.getElementById('logoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => { logoImage = img; };
                };
                reader.readAsDataURL(file);
            }
        });

        function resetApp() {
            currentNominal = 0;
            updateInputDisplay();
            document.getElementById('note').value = '';
            document.getElementById('resultCard').classList.add('hidden');
        }

        function generateQR() {
            if (currentNominal === 0) {
                alert("Masukkan nominal terlebih dahulu");
                return;
            }

            const note = document.getElementById('note').value;
            const colorDark = document.getElementById('colorDark').value;
            const colorLight = document.getElementById('colorLight').value;
            
            document.getElementById('resultCard').classList.remove('hidden');
            
            const textData = `Rp ${currentNominal.toLocaleString('id-ID')}` + (note ? ` (${note})` : '');
            
            document.getElementById('resNominal').innerText = `Rp ${currentNominal.toLocaleString('id-ID')}`;
            document.getElementById('resNote').innerText = note || '-';

            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';

            // Generate QR
            new QRCode(qrContainer, {
                text: textData,
                width: 200,
                height: 200,
                colorDark : colorDark,
                colorLight : colorLight,
                correctLevel : QRCode.CorrectLevel.H
            });

            // Handle Logo Overlay
            setTimeout(() => {
                if (logoImage) {
                    renderCanvasWithLogo(textData, colorDark, colorLight);
                }
            }, 100);

            saveToHistory(currentNominal, note);
        }

        function renderCanvasWithLogo(text, colorDark, colorLight) {
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = ''; 

            const tempDiv = document.createElement('div');
            const qrTemp = new QRCode(tempDiv, {
                text: text,
                width: 200,
                height: 200,
                colorDark : colorDark,
                colorLight : colorLight,
                correctLevel : QRCode.CorrectLevel.H
            });

            setTimeout(() => {
                const qrImg = tempDiv.querySelector('img');
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');

                ctx.drawImage(qrImg, 0, 0);

                if (logoImage) {
                    const logoSize = 50; 
                    const logoPos = (200 - logoSize) / 2;
                    ctx.fillStyle = colorLight; 
                    ctx.fillRect(logoPos - 2, logoPos - 2, logoSize + 4, logoSize + 4);
                    ctx.drawImage(logoImage, logoPos, logoPos, logoSize, logoSize);
                }
                qrContainer.appendChild(canvas);
            }, 50);
        }

        function downloadQR() {
            const qrDiv = document.getElementById('qrcode');
            const canvas = qrDiv.querySelector('canvas') || qrDiv.querySelector('img');
            
            if (canvas) {
                const link = document.createElement('a');
                link.href = canvas.tagName === 'IMG' ? canvas.src : canvas.toDataURL("image/png");
                link.download = `QR-${currentNominal}-${Date.now()}.png`;
                link.click();
            }
        }

        async function shareQR() {
            const qrDiv = document.getElementById('qrcode');
            const canvas = qrDiv.querySelector('canvas');
            
            if (!canvas) {
                alert("Format QR saat ini (Image) tidak mendukung share langsung. Silakan download manual.");
                return;
            }

            canvas.toBlob(async (blob) => {
                const file = new File([blob], "qr-code.png", { type: "image/png" });
                
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'QR Code Tagihan',
                            text: `Tagihan sebesar Rp ${currentNominal.toLocaleString('id-ID')}`,
                            files: [file]
                        });
                    } catch (err) { }
                } else {
                    alert("Browser Anda tidak mendukung fitur share langsung.");
                }
            });
        }

        // --- HISTORY SYSTEM ---
        function saveToHistory(nominal, note) {
            let history = JSON.parse(localStorage.getItem('qrHistory')) || [];
            
            const newItem = {
                id: Date.now(),
                nominal: nominal,
                note: note,
                date: new Date().toLocaleDateString('id-ID')
            };

            history.unshift(newItem);
            if(history.length > 10) history.pop();

            localStorage.setItem('qrHistory', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            let history = JSON.parse(localStorage.getItem('qrHistory')) || [];
            const listEl = document.getElementById('historyList');
            listEl.innerHTML = '';

            if (history.length === 0) {
                listEl.innerHTML = '<li class="p-4 text-center text-xs text-slate-400 dark:text-slate-500">Belum ada riwayat</li>';
                return;
            }

            history.forEach(item => {
                const li = document.createElement('li');
                li.className = 'p-3 hover:bg-slate-50 dark:hover:bg-slate-700/50 flex justify-between items-center cursor-pointer transition';
                li.onclick = () => restoreFromHistory(item.nominal, item.note);
                
                li.innerHTML = `
                    <div>
                        <p class="font-bold text-slate-700 dark:text-slate-200 text-sm">Rp ${item.nominal.toLocaleString('id-ID')}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">${item.note || 'Tanpa catatan'}</p>
                    </div>
                    <span class="text-[10px] text-slate-400 dark:text-slate-500">${item.date}</span>
                `;
                listEl.appendChild(li);
            });
        }

        function restoreFromHistory(nominal, note) {
            currentNominal = nominal;
            document.getElementById('note').value = note;
            updateInputDisplay();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function clearHistory() {
            if(confirm("Hapus semua riwayat?")) {
                localStorage.removeItem('qrHistory');
                loadHistory();
            }
        }
    </script>
</body>
</html>

